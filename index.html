<script>
const firebaseConfig = {
  apiKey: "AIzaSyBe9w-5wQTIYKQ-4uNkWfVfpuqK647tZng",
  authDomain: "private-chat-ak2528.firebaseapp.com",
  projectId: "private-chat-ak2528",
  storageBucket: "private-chat-ak2528.firebasestorage.app",
  messagingSenderId: "56256948298",
  appId: "1:56256948298:web:4b90dfc7a381cb67801eb3"
};

firebase.initializeApp(firebaseConfig);

const auth = firebase.auth();
const db = firebase.firestore();

let currentUser = null;
let clearedAt = null;
let unsubscribe = null;

// ---------- AUTH ----------
auth.onAuthStateChanged(async user => {
  if (!user) return;

  currentUser = user.email;

  document.getElementById("login").style.display = "none";
  document.getElementById("chat").style.display = "block";

  document.getElementById("userLabel").innerText = currentUser;

  await initUserMeta();
  loadMessages();
});

// ---------- USER META ----------
async function initUserMeta() {
  const ref = db.collection("userChatMeta").doc(currentUser);

  const snap = await ref.get();
  if (!snap.exists) {
    await ref.set({
      clearedAt: firebase.firestore.Timestamp.fromMillis(0)
    });
    clearedAt = firebase.firestore.Timestamp.fromMillis(0);
  } else {
    clearedAt = snap.data().clearedAt || firebase.firestore.Timestamp.fromMillis(0);
  }
}

// ---------- LOAD MESSAGES ----------
function loadMessages() {
  if (unsubscribe) unsubscribe();

  unsubscribe = db.collection("messages")
    .orderBy("time")
    .onSnapshot(snap => {
      messages.innerHTML = "";

      snap.forEach(doc => {
        const m = doc.data();
        if (!m.time || m.time.toMillis() <= clearedAt.toMillis()) return;

        const div = document.createElement("div");
        div.className = "msg " + (m.sender === currentUser ? "me" : "other");

        const t = m.time.toDate().toLocaleString("en-IN", {
          day: "2-digit",
          month: "short",
          hour: "2-digit",
          minute: "2-digit"
        });

        div.innerHTML = `
          ${m.text}
          <div class="sender">${m.sender} â€¢ ${t}</div>
        `;

        messages.appendChild(div);
      });

      messages.scrollTop = messages.scrollHeight;
    });
}

// ---------- SEND ----------
function sendText() {
  if (!msg.value.trim()) return;

  db.collection("messages").add({
    text: msg.value,
    sender: currentUser,
    time: firebase.firestore.FieldValue.serverTimestamp()
  });

  msg.value = "";
}

sendBtn.onclick = sendText;

msg.addEventListener("keydown", e => {
  if (e.key === "Enter") sendText();
});

// ---------- CLEAR CHAT (FIXED) ----------
clearBtn.onclick = async () => {
  const now = firebase.firestore.Timestamp.now();

  await db.collection("userChatMeta")
    .doc(currentUser)
    .set({ clearedAt: now }, { merge: true });

  clearedAt = now;
  messages.innerHTML = "";
};

// ---------- LOGOUT ----------
logoutBtn.onclick = () => auth.signOut();

// ---------- LOGIN ----------
loginBtn.onclick = () => {
  auth.signInWithEmailAndPassword(email.value, password.value)
    .catch(e => alert(e.message));
};
</script>
