<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>We Chat</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
body{margin:0;font-family:Arial;background:#f0f2f5}
header{background:#008069;color:white;padding:14px;text-align:center}

#login,#chat{max-width:600px;margin:auto;padding:12px}

input,textarea{width:100%;padding:10px;margin:6px 0}

button{padding:10px;border:none;border-radius:6px}

#loginBtn{background:#008069;color:white;width:100%}

#messages{height:60vh;overflow:auto;background:#efeae2;padding:10px;border-radius:6px}

.msg{padding:8px;margin-bottom:6px;border-radius:8px;max-width:75%}
.me{background:#d9fdd3;margin-left:auto}
.other{background:white}

.sender{font-size:11px;color:#555}

#bar{display:flex;gap:8px}
#msg{flex:1;border-radius:20px}

#sendBtn{width:50px;background:#008069;color:white;border-radius:50%}

#clearBtn{background:#ff4d4d;color:white;width:100%;margin-top:8px}
#logoutBtn{background:#666;color:white;width:100%;margin-top:8px}

#status{text-align:center;font-size:12px;color:#444;margin-bottom:4px}
</style>
</head>

<body>

<header>ðŸ’¬ We Chat</header>

<div id="login">
<input id="email" placeholder="Email">
<input id="password" type="password" placeholder="Password">
<button id="loginBtn">Login</button>
</div>

<div id="chat" style="display:none">

<div id="status"></div>

<div id="messages"></div>

<div id="bar">
<textarea id="msg" placeholder="Type message"></textarea>
<button id="sendBtn">âž¤</button>
</div>

<button id="clearBtn">Clear Chat</button>
<button id="logoutBtn">Logout</button>

</div>

<script>

const firebaseConfig={
apiKey:"AIzaSyBe9w-5wQTIYKQ-4uNkWfVfpuqK647tZng",
authDomain:"private-chat-ak2528.firebaseapp.com",
projectId:"private-chat-ak2528",
storageBucket:"private-chat-ak2528.appspot.com",
messagingSenderId:"56256948298",
appId:"1:56256948298:web:4b90dfc7a381cb67801eb3"
};

firebase.initializeApp(firebaseConfig);

const auth=firebase.auth();
const db=firebase.firestore();

let currentUser=null;
let clearedAt=firebase.firestore.Timestamp.fromMillis(0);
let unsub=null;
let userDoc=null;

auth.setPersistence(firebase.auth.Auth.Persistence.NONE);

auth.onAuthStateChanged(async u=>{
if(!u)return;

currentUser=u.email;

login.style.display="none";
chat.style.display="block";

userDoc=db.collection("users").doc(currentUser);

await userDoc.set({
online:true,
lastSeen:firebase.firestore.FieldValue.serverTimestamp()
},{merge:true});

await initMeta();
loadMessages();
watchOtherUser();

setInterval(()=>{
userDoc.set({
online:true,
lastSeen:firebase.firestore.FieldValue.serverTimestamp()
},{merge:true});
},20000);
});

async function initMeta(){
const r=db.collection("userChatMeta").doc(currentUser);
const s=await r.get();
if(!s.exists){
await r.set({clearedAt:firebase.firestore.Timestamp.fromMillis(0)});
}
clearedAt=(await r.get()).data().clearedAt;
}

function loadMessages(){
if(unsub)unsub();

unsub=db.collection("messages").orderBy("time").onSnapshot(q=>{
messages.innerHTML="";
q.forEach(d=>{
const m=d.data();
if(!m.time||m.time.toMillis()<=clearedAt.toMillis())return;

const t=m.time.toDate().toLocaleString("en-IN",{hour:"2-digit",minute:"2-digit"});
const div=document.createElement("div");
div.className="msg "+(m.sender===currentUser?"me":"other");
div.innerHTML=`${m.text}<div class="sender">${m.sender} â€¢ ${t}</div>`;
messages.appendChild(div);
});
messages.scrollTop=messages.scrollHeight;
});
}

sendBtn.onclick=sendText;

function sendText(){
if(!msg.value.trim())return;
db.collection("messages").add({
text:msg.value,
sender:currentUser,
time:firebase.firestore.FieldValue.serverTimestamp()
});
msg.value="";
}

msg.addEventListener("keydown",e=>{
if(e.key==="Enter"){
e.preventDefault();
sendText();
}
});

clearBtn.onclick=async()=>{
const now=firebase.firestore.Timestamp.now();
await db.collection("userChatMeta").doc(currentUser).set({clearedAt:now},{merge:true});
clearedAt=now;
messages.innerHTML="";
};

logoutBtn.onclick=async()=>{
await userDoc.set({
online:false,
lastSeen:firebase.firestore.FieldValue.serverTimestamp()
},{merge:true});
auth.signOut();
location.reload();
};

loginBtn.onclick=()=>{
auth.signInWithEmailAndPassword(email.value,password.value)
.catch(e=>alert(e.message));
};

window.addEventListener("beforeunload",()=>{
if(!currentUser)return;
db.collection("users").doc(currentUser).set({
online:false,
lastSeen:firebase.firestore.FieldValue.serverTimestamp()
},{merge:true});
});

function watchOtherUser(){
db.collection("users").onSnapshot(s=>{
s.forEach(d=>{
if(d.id!==currentUser){
const u=d.data();
if(u.online){
status.innerText=d.id+" â€¢ Online";
}else if(u.lastSeen){
const t=u.lastSeen.toDate().toLocaleString("en-IN",{hour:"2-digit",minute:"2-digit"});
status.innerText=d.id+" â€¢ Last seen "+t;
}
}
});
});
}

</script>
</body>
</html>
